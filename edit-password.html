<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Password</title>
  <style>
    :root{--bg:#071021;--card:#0f1724;--muted:#98a0b3;--accent:#5b8bf7}
    body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,#061022,#071021);color:#e6eefc}
    .container{max-width:1000px;margin:24px auto;padding:18px}
    .grid{display:flex;gap:18px}
    .left{flex:1}
    .right{width:320px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.04)}
    .heading{font-size:22px;font-weight:700;margin-bottom:6px}
    .muted{color:var(--muted);margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:600}
    input[type="text"], input[type="password"], input[type="number"]{
      width:100%; padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.05); background:rgba(255,255,255,0.02); color:#eaf2ff;
      box-sizing:border-box;
    }
    .row{display:flex;gap:12px;align-items:center}
    .btn{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,#5b8bf7,#6bc7ff);color:#042235}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#eaf2ff}
    .small-muted{font-size:13px;color:var(--muted)}
    .form-row{margin-bottom:14px}
    .tips li{margin-bottom:8px}
    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}
    .alert{padding:10px;border-radius:8px;margin-top:10px;font-size:13px}
    .alert.success{background:#e6fff4;color:#083f2e}
    .alert.error{background:#fff1f2;color:#5b1d1f}
  </style>
</head>
<body>
  <div class="container">
    <div class="heading">Edit Password</div>
    <div class="muted">For your security, a one-time code will be sent to your email before changing the password.</div>

    <div class="grid">
      <!-- left card: form -->
      <div class="left">
        <div class="card">
          <h3 style="margin:0 0 10px 0;color:#dff0ff">Account</h3>

          <div class="form-row">
            <label for="name">Name</label>
            <input id="name" type="text" value="Loading..." readonly />
          </div>

          <div class="form-row">
            <label for="email">Email</label>
            <input id="email" type="text" value="Loading..." readonly />
          </div>

          <div class="form-row">
            <div style="display:flex;gap:10px;align-items:center">
              <button id="sendOtpBtn" class="btn primary">Send OTP</button>
              <div id="otpStatus" class="small-muted">Not sent</div>
            </div>
          </div>

          <div class="form-row">
            <label for="otp">OTP Code</label>
            <input id="otp" type="number" placeholder="Enter 6-digit code" />
          </div>

          <div class="form-row">
            <label for="newpass">New Password</label>
            <input id="newpass" type="password" placeholder="New password" />
          </div>

          <div class="form-row">
            <label for="confpass">Confirm Password</label>
            <input id="confpass" type="password" placeholder="Retype the password" />
          </div>

          <div class="actions">
            <button id="cancelBtn" class="btn ghost">‚Üê Cancel</button>
            <button id="updateBtn" class="btn primary">üîí Update Password</button>
          </div>

          <div id="msg" style="margin-top:12px;font-size:14px"></div>
        </div>
      </div>

      <!-- right: tips -->
      <div class="right">
        <div class="card">
          <h4 style="margin:0 0 8px 0">Tips</h4>
          <ul class="tips small-muted">
            <li>Use at least 8 characters with uppercase, lowercase, number, and special character.</li>
            <li>Don't reuse your old passwords.</li>
            <li>Never share your OTP or password with anyone.</li>
          </ul>
          <div style="margin-top:12px" class="small-muted">Protected with email verification</div>
        </div>
      </div>
    </div> <!-- grid -->
  </div>

<script>
  const API_BASE = window.API_BASE || "http://127.0.0.1:5000";
  
  // Function to fetch user profile and update display
  async function loadUserProfile() {
    try {
      console.log('Loading user profile from localStorage...');
      
      // Try to get user from localStorage first
      const currentUserStr = localStorage.getItem('currentUser');
      if (currentUserStr) {
        const user = JSON.parse(currentUserStr);
        console.log('User data from localStorage:', user);
        
        if (user) {
          // Update user information in the form
          document.getElementById('name').value = user.name;
          document.getElementById('email').value = user.email;
          console.log('User profile updated successfully from localStorage');
          return;
        }
      }
      
      // If not in localStorage, try to fetch from server
      console.log('Fetching user profile from server...');
      const response = await fetch('/profile', {
        credentials: 'include' // Include cookies/session data
      });
      console.log('Profile response status:', response.status);
      console.log('Profile response headers:', [...response.headers.entries()]);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('Profile fetch failed with status:', response.status, 'Body:', errorText);
        throw new Error(`Failed to fetch profile: ${response.status} ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Profile data received:', data);
      
      if (data.user) {
        // Update user information in the form
        document.getElementById('name').value = data.user.name;
        document.getElementById('email').value = data.user.email;
        console.log('User profile updated successfully from server');
      } else {
        console.warn('No user data in profile response');
        throw new Error('No user data in profile response');
      }
    } catch (error) {
      console.error('Error loading user profile:', error);
      // Fallback to default if there's an error
      document.getElementById('name').value = 'Guest User';
      document.getElementById('email').value = 'guest@example.com';
    }
  }

  // Call the function to load user profile when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadUserProfile();
  });

  // Real OTP functionality
  const sendBtn = document.getElementById('sendOtpBtn');
  const otpStatus = document.getElementById('otpStatus');
  const nameField = document.getElementById('name');
  const emailField = document.getElementById('email');
  const otpInput = document.getElementById('otp');
  const newpass = document.getElementById('newpass');
  const confpass = document.getElementById('confpass');
  const msg = document.getElementById('msg');
  let otpSent = false;

  function showMessage(text, type='success'){
    msg.innerHTML = `<div class="alert ${type==='success' ? 'success' : 'error'}">${text}</div>`;
    setTimeout(()=> {
      msg.innerHTML = '';
    }, 5000);
  }

  // Send OTP
  sendBtn.addEventListener('click', async function(){
    const email = (emailField.value || '').trim();
    if (!email) {
      showMessage('Email not found. Please refresh the page.', 'error');
      return;
    }

    sendBtn.disabled = true;
    otpStatus.textContent = 'Sending...';
    
    try {
      const response = await fetch(API_BASE + '/send-otp', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email })
      });

      const text = await response.text().catch(()=>null);
      let body = null;
      try { body = text ? JSON.parse(text) : null; } catch(e){ body = null; }

      if(response.ok && body && body.sent){
        otpSent = true;
        otpStatus.textContent = 'OTP sent to email';
        showMessage('OTP sent successfully. Check your email.', 'success');
      } else {
        otpSent = false;
        otpStatus.textContent = 'Failed to send';
        showMessage('Failed to send OTP: ' + (body?.error || body?.detail || 'Unknown error'), 'error');
      }
    } catch (error) {
      otpSent = false;
      otpStatus.textContent = 'Failed to send';
      showMessage('Network error. Please try again.', 'error');
      console.error('Send OTP error:', error);
    } finally {
      sendBtn.disabled = false;
    }
  });

  // Cancel button
  document.getElementById('cancelBtn').addEventListener('click', function(e){
    e.preventDefault();
    // go back to dashboard
    window.location.href = 'dashboard.html';
  });

  // Update password
  document.getElementById('updateBtn').addEventListener('click', async function(){
    msg.textContent = ''; msg.style.color = '';

    const email = (emailField.value || '').trim();
    const providedOtp = (otpInput.value || '').trim();
    const newPassword = newpass.value.trim();
    const confirmPassword = confpass.value.trim();

    if(!otpSent){
      showMessage('Please send OTP to your email first.', 'error');
      return;
    }
    
    if(!providedOtp){
      showMessage('Please enter the OTP.', 'error');
      return;
    }
    
    // Verify OTP first
    try {
      const verifyResponse = await fetch(API_BASE + '/verify-otp', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email, otp: providedOtp })
      });

      const verifyText = await verifyResponse.text().catch(()=>null);
      let verifyBody = null;
      try { verifyBody = verifyText ? JSON.parse(verifyText) : null; } catch(e){ verifyBody = null; }

      if(!verifyResponse.ok || !verifyBody || !verifyBody.verified){
        showMessage('Invalid or expired OTP.', 'error');
        return;
      }
      
      // OTP verified, now update password
      if(newPassword.length < 8){
        showMessage('Password must be at least 8 characters.', 'error');
        return;
      }
      
      // Check for at least one uppercase letter
      if (!/[A-Z]/.test(newPassword)) {
        showMessage('Password must contain at least one uppercase letter.', 'error');
        return;
      }
      
      // Check for at least one lowercase letter
      if (!/[a-z]/.test(newPassword)) {
        showMessage('Password must contain at least one lowercase letter.', 'error');
        return;
      }
      
      // Check for at least one digit
      if (!/\d/.test(newPassword)) {
        showMessage('Password must contain at least one number.', 'error');
        return;
      }
      
      // Check for at least one special character
      if (!/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(newPassword)) {
        showMessage('Password must contain at least one special character (!@#$%^&*()_+-=[]{}|;:,.<>?).', 'error');
        return;
      }
      
      if(newPassword !== confirmPassword){
        showMessage('Passwords do not match.', 'error');
        return;
      }

      // Call the password update endpoint
      try {
        const updateResponse = await fetch(API_BASE + '/update-password', {
          method: 'POST',
          credentials: 'include',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ 
            // current_password: '', // Not required since OTP verification serves as authentication
            new_password: newPassword 
          })
        });

        const updateText = await updateResponse.text().catch(()=>null);
        let updateBody = null;
        try { updateBody = updateText ? JSON.parse(updateText) : null; } catch(e){ updateBody = null; }

        if(updateResponse.ok && updateBody && updateBody.updated){
          showMessage('Password updated successfully. Redirecting to dashboard...', 'success');
          
          // Clear OTP state and form fields
          otpSent = false;
          otpInput.value = '';
          newpass.value = '';
          confpass.value = '';
          
          setTimeout(()=> window.location.href = 'dashboard.html', 2000);
        } else {
          showMessage('Failed to update password: ' + (updateBody?.error || updateBody?.detail || 'Unknown error'), 'error');
        }
      } catch (error) {
        showMessage('Network error during password update. Please try again.', 'error');
        console.error('Password update error:', error);
      }
    } catch (error) {
      showMessage('Network error during verification. Please try again.', 'error');
      console.error('Verify OTP error:', error);
    }
  });
</script>
</body>
</html>